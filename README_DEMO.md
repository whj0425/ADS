# 分布式银行系统演示指南

本文档提供了如何在两台电脑上演示分布式银行系统的详细说明。

## 系统架构

分布式银行系统由以下几个主要组件组成：

1. **事务协调器(Transaction Coordinator)**: 负责协调分布式事务的执行，实现两阶段提交协议
2. **账户节点(Account Node)**: 维护银行账户的数据，分为主节点和备份节点
3. **客户端(Client)**: 提供用户界面，允许用户执行账户查询和转账操作

## 两台电脑部署方案

我们采用以下部署方案在两台电脑上演示分布式系统：

**电脑A**:
- 运行事务协调器(Transaction Coordinator)
- 运行账户节点a1和备份a1b
- 运行客户端

**电脑B**:
- 运行账户节点a2和备份a2b
- 运行客户端

## 准备工作

在开始演示之前，请确保：

1. 两台电脑都已安装Python 3.6+
2. 两台电脑网络互通（可以相互ping通）
3. 在两台电脑上都克隆/复制了完整的项目代码
4. 修改`start_computer_A.py`和`start_computer_B.py`中的IP地址配置：
   - 在`start_computer_A.py`中设置`COMPUTER_A_IP`为电脑A的实际IP地址
   - 在`start_computer_B.py`中设置`COMPUTER_A_IP`为电脑A的实际IP地址
   - 在两个脚本中都设置`COMPUTER_B_IP`为电脑B的实际IP地址

## 启动步骤

### 电脑A上的操作

1. 打开终端，进入项目目录
2. 执行以下命令启动电脑A上的组件：
   ```bash
   python start_computer_A.py
   ```
3. 脚本将自动启动：
   - 事务协调器
   - 账户节点a1（主节点）
   - 账户节点a1b（备份节点）
   - 客户端

### 电脑B上的操作

1. 在电脑A启动完成后，在电脑B上打开终端，进入项目目录
2. 执行以下命令启动电脑B上的组件：
   ```bash
   python start_computer_B.py
   ```
3. 脚本将自动启动：
   - 账户节点a2（主节点）
   - 账户节点a2b（备份节点）
   - 客户端

## 演示场景

启动完成后，您可以使用以下工具进行系统演示：

### 演示脚本

在任何一台电脑上，您可以运行演示脚本来执行各种演示场景：
```bash
python demo_scenarios.py [协调器IP] [协调器端口]
```

例如，在电脑B上运行演示脚本连接到电脑A的协调器：
```bash
python demo_scenarios.py 172.20.10.2 5010
```

演示脚本提供了以下功能：
1. 转账演示：演示正常的转账操作
2. 故障恢复演示：模拟节点故障并展示系统恢复过程
3. 并发转账演示：展示系统处理并发事务的能力
4. 列出所有账户：查看当前系统中的所有账户节点
5. 检查节点状态：检查特定节点的状态
6. 模拟节点故障：手动触发节点故障

### 客户端操作

您也可以直接使用自动启动的客户端执行以下操作：
- `list`: 列出所有可用账户
- `transfer <from> <to> <amount>`: 转账操作，例如 `transfer a1 a2 100`
- `init <amount>`: 初始化所有账户余额
- `balance <account_id>`: 查询账户余额
- `help`: 显示帮助信息
- `exit`: 退出客户端

## 演示流程建议

以下是推荐的演示流程：

1. **基本功能演示**:
   - 使用客户端初始化账户余额：`init 10000`
   - 查询各账户余额：`balance a1` 和 `balance a2`
   - 执行简单转账并验证余额变化：`transfer a1 a2 1000`，然后再次查询余额

2. **跨节点转账演示**:
   - 在电脑A上发起从a1到a2的转账：`transfer a1 a2 2000`
   - 在电脑B上发起从a2到a1的转账：`transfer a2 a1 1000`
   - 验证两笔转账都成功完成：在任一电脑上查询余额 `balance a1` 和 `balance a2`

3. **故障恢复演示**:
   - 在任一电脑上运行`demo_scenarios.py [协调器IP] [协调器端口]`
   - 选择"6. 模拟节点故障"选项，输入`a1`模拟主节点故障
   - 等待几秒钟让系统检测到故障并启动故障恢复流程
   - 选择"5. 检查节点状态"，检查a1和a1b的状态
   - 在任一电脑的客户端中执行转账：`transfer a1 a2 500`
   - 验证转账是否成功完成，以及备份节点a1b是否已成为新的主节点

4. **并发操作演示**:
   - 在任一电脑上运行`demo_scenarios.py [协调器IP] [协调器端口]`
   - 选择"3. 并发转账演示"
   - 观察系统如何处理以下并发转账：
     ```
     a1 -> a2 (100)
     a2 -> a1 (200)
     a1 -> a2 (300)
     a2 -> a1 (400)
     a1 -> a2 (500)
     ```
   - 验证最终余额是否正确，确认没有出现数据不一致的问题

## 详细演示指令操作指南

### 1. 转账演示

该演示展示了系统正常的转账功能，包括以下步骤：

1. 初始化所有账户余额为10000
2. 查询并显示a1和a2的初始余额
3. 执行一笔从a1到a2的1000金额转账
4. 再次查询并显示转账后的余额变化

**预期结果**：
- 转账成功完成
- a1余额减少1000，变为9000
- a2余额增加1000，变为11000

### 2. 故障恢复演示

该演示展示了系统在节点故障情况下的容错能力，包括以下步骤：

1. 列出当前系统中的所有账户节点
2. 模拟a1节点故障
3. 等待5秒钟，让系统检测故障并启动恢复流程
4. 检查a1和a1b节点的状态
5. 在a1节点故障期间尝试执行从a1到a2的转账
6. 查询转账后的账户余额

**预期结果**：
- a1节点被标记为故障状态
- a1b节点被提升为新的主节点
- 即使a1故障，转账仍然成功执行
- 系统显示转账是通过备份节点完成的
- 余额变化正确反映在系统中

### 3. 并发转账演示

该演示展示了系统处理并发事务的能力，包括以下步骤：

1. 初始化所有账户余额为10000
2. 查询并显示a1和a2的初始余额
3. 同时启动5个并发转账操作：
   - a1 -> a2 转账100
   - a2 -> a1 转账200
   - a1 -> a2 转账300
   - a2 -> a1 转账400
   - a1 -> a2 转账500
4. 等待所有并发转账完成
5. 查询并显示最终账户余额

**预期结果**：
- 所有5个并发转账都成功完成
- 最终余额计算正确：
  - a1: 10000 - 100 - 300 - 500 + 200 + 400 = 9700
  - a2: 10000 + 100 + 300 + 500 - 200 - 400 = 10300
- 没有出现数据不一致或死锁的问题

### 4. 检查节点状态

此功能允许检查特定节点的当前状态，包括：
- 节点是否活跃
- 节点角色（主节点或备份节点）
- 节点的备份节点（如果有）

使用方法：选择"5. 检查节点状态"，然后输入节点ID（如a1、a1b、a2或a2b）

### 5. 模拟节点故障

此功能允许手动触发节点故障，用于测试系统的故障恢复能力：

使用方法：选择"6. 模拟节点故障"，然后输入要模拟故障的节点ID（如a1或a2）

## 常见问题

1. **连接超时**:
   - 确保两台电脑网络互通
   - 检查IP地址设置是否正确
   - 确保防火墙未阻止相关端口

2. **节点未正确配对**:
   - 重启系统，确保按正确的顺序启动各组件
   - 检查日志输出，确认协调器是否正确识别了节点关系

3. **转账失败**:
   - 检查账户余额是否充足
   - 确保相关节点都处于活跃状态
   - 查看日志输出，了解详细错误信息

## 总结

通过这个两台电脑的部署演示，我们可以直观地展示分布式系统的以下关键特性：

1. **分布式通信**: 不同电脑上的节点如何通过网络进行通信
2. **一致性保证**: 分布式事务如何确保数据一致性
3. **容错机制**: 系统如何处理节点故障并通过备份节点恢复服务
4. **并发控制**: 系统如何处理并发操作并防止数据竞争 