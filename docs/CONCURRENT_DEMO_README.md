# 并发转账问题演示与解决方案

本文档介绍分布式银行系统中的并发转账问题及其解决方案。

## 问题描述

在当前的分布式银行系统中，执行并发转账演示时会遇到以下问题：

1. **并发请求处理不当**：多个并发转账请求同时发送时，协调器无法正确处理这些请求，导致部分请求超时或失败。

2. **锁粒度过大**：系统使用全局锁保护资源，当多个不相关账户的转账同时进行时也会相互阻塞，降低了系统吞吐量。

3. **错误处理不完善**：两阶段提交过程中，错误恢复机制不完善，导致在某些步骤失败时无法正确回滚事务。

4. **缺乏事务状态追踪**：系统缺乏完整的事务日志记录，难以追踪事务执行过程和状态，导致出现问题时难以排查。

## 演示方法

可以通过以下步骤重现并观察问题：

1. 先启动计算机A和计算机B的程序：
   ```
   # 在计算机A上
   python start_computer_A.py
   
   # 在计算机B上
   python start_computer_B.py
   ```

2. 在任一计算机上运行演示程序并选择选项3（并发转账演示）：
   ```
   python demo_scenarios.py
   ```

3. 观察控制台输出，会发现：
   - 部分转账请求失败或超时
   - 在检查最终余额时可能会出现连接超时
   - 最终的余额状态可能与预期的不一致

## 解决方案

我们提出了以下解决方案来改进并发转账处理：

### 1. 全局事务队列和排序

就像银行柜台一样，所有交易按顺序排队处理而不是同时处理，避免混乱。

- 在协调器中引入事务队列，顺序处理转账请求
- 每个转账请求分配唯一事务ID，按照接收顺序处理
- 避免并发事务直接竞争资源

### 2. 账户级别的锁

一个道路维修不应该导致整个城市交通瘫痪，只需要封锁特定路段。

- 为每个账户使用独立的锁，只有涉及同一账户的交易才需要互相等待
- 使用固定顺序获取锁（如按账户ID排序）以避免死锁
- 大幅提高不相关账户间的并发性能

### 3. 完善的两阶段提交过程

银行转账需要完整的验证、执行和确认过程，任何步骤出错都需要有明确处理方案。

- 完整实现两阶段提交协议，包括准备、执行和提交/回滚阶段
- 添加超时处理和错误恢复机制
- 当执行失败时能够正确回滚事务

### 4. 事务日志和状态跟踪

就像银行流水账单，记录每笔交易的所有步骤和状态，方便查询和问题排查。

- 记录详细的事务日志，包括每个阶段的执行状态
- 记录事务的每一步操作和结果
- 方便故障恢复和问题排查

## 改进版演示

可以通过选择菜单选项7（改进版并发转账演示）来观察改进后的系统性能：

- 所有并发转账都能正确完成
- 转账完成后能正确查询两个账户的余额
- 最终的余额状态与预期一致

## 技术实现细节

改进版系统的关键实现变化：

1. **ImprovedTransactionCoordinator** 类中实现了全局事务队列和账户级别的锁
2. **execute_transfer_with_retry** 方法实现了完善的两阶段提交和重试机制
3. **log_transaction** 方法实现了事务日志记录
4. 使用**ThreadPoolExecutor**代替直接创建线程，更好地管理并发任务

## 对比演示

为了清楚展示改进效果，可以按照以下步骤进行对比演示：

1. 先运行选项3（并发转账演示），观察问题
2. 再运行选项7（改进版并发转账演示），观察改进效果
3. 对比两次演示的结果，包括成功率、最终余额和验证结果 